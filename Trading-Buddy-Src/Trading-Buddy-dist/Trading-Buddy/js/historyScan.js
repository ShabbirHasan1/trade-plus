(()=>{const u=$("#SymbType").next().next().next().text().match(new RegExp("userName': '(.*)',"))[1],p=$("#SymbType").next().next().next().text().match(new RegExp("sessionID': '(.*)',"))[1],d=$("#SymbType").val(),_=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"],g={CALL_OI_CHANGE:9,CE_THETA:4,CALL_OI:10,STRIKE_PRICE:17,CE_VWAP:14,PE_VWAP:20,PUT_OI:24,PUT_OI_CHANGE:25,CE_LTP:13,PE_LTP:21,PE_THETA:30,OI_PCR:32};async function a(t,e,a){$("#screener-title").html("<h3>Monthly Screener Chart</h3>");let o=new Date(t,e,a);console.log(o);const l=""+_[o.getMonth()]+o.getFullYear()%100,n=""+_[(o.getMonth()+1)%12]+(11==o.getMonth()?o.getFullYear()%100+1:o.getFullYear()%100),s=""+_[(o.getMonth()+2)%12]+(11==o.getMonth()?o.getFullYear()%100+1:o.getFullYear()%100),r=""+_[(o.getMonth()+3)%12]+(11==o.getMonth()?o.getFullYear()%100+1:o.getFullYear()%100);let i=[],c=[],h=[],u=[],p=A();p.forEach(t=>{t.includes(l)?i.push(t):t.includes(n)?c.push(t):t.includes(s)?h.push(t):t.includes(r)&&u.push(t)});const d=i.sort().slice(-1)[0],g=c.sort().slice(-1)[0],y=h.sort().slice(-1)[0];var C=u.sort().slice(-1)[0];console.log(d,g,y,C);let E=[],L=[],P=[],D=[],T=[],b=[],f="Date,ATM-ITM-CE-LOTS,ATM-ITM-PE-LOTS,ALL-CE,ALL-PE,Fut-Price\n";for(let t=0;t<30;o.setDate(o.getDate()+1),t++)if($(".ichart-screener-monthly").text(`History Load ${parseFloat(t/30*100).toFixed(2)}%`),![0,6].includes(o.getDay())){if(o>new Date)break;var m=o.getFullYear(),F=O(o.getMonth()+1),x=O(o.getDate()),I=m+`-${F}-`+x,v=""+_[o.getMonth()]+o.getFullYear()%100,M=x+v;let t="",e="";d.includes(v)?e=M<=d?(t=d,g):(t=g,y):g.includes(v)?e=M<=g?(t=g,y):(t=y,C):y.includes(v)&&(t=y,e=C);var{ceLots:m,peLots:F,allCeLots:x,allPeLots:v,futPrice:I}=await w(I,[t,e]);E.push(M),L.push(m),P.push(F),D.push(x),T.push(v),b.push(I),f+=M+`,${m},${F},${x},${v},${I}
`}console.log("CSV Export for Google Sheet"),console.log(f),S(E,L,P,D,T,b)}async function o(t,e,a){$("#screener-title").html("<h3>Weekly Screener Chart</h3>");var o,l;let n=new Date(t,e,a),s=new Date(t,e,a);s.setDate(s.getDate()+21);let r=A(),i=[];for(;n<s;n.setDate(n.getDate()+1))[0,6].includes(n.getDay())||(o=""+O(n.getDate())+_[n.getMonth()]+n.getFullYear()%100,r.includes(o)&&i.push(o));n=new Date(t,e,a);let c=[],h=[],u=[],p=[],d=[],g=[];for(let t=0;n<s;n.setDate(n.getDate()+1),t++)if(![0,6].includes(n.getDay())){if(n>new Date)break;$(".ichart-screener-weekly").text(`History Load ${parseFloat(t/21*100).toFixed(2)}%`);let e=[],a=new Date(n.getTime());for(let t=0;t<21;a.setDate(a.getDate()+1),t++)[0,6].includes(a.getDay())||(l=""+O(a.getDate())+_[a.getMonth()]+a.getFullYear()%100,r.includes(l)&&e.push(l));var y=n.getFullYear(),C=O(n.getMonth()+1),E=O(n.getDate()),{ceLots:L,peLots:P,allCeLots:D,allPeLots:T,futPrice:b}=await w(y+`-${C}-`+E,e);c.push(""+E+_[C-1]+y%100),h.push(L),u.push(P),p.push(D),d.push(T),g.push(b)}S(c,h,u,p,d,g)}function A(){let a=[];return $("#optExpDate_hist option").each((t,e)=>{a.push($(e).attr("value").toUpperCase())}),a}function S(t,e,a,o,l,n){n={type:"line",options:{interaction:{intersect:!1,mode:"index"},plugins:{tooltip:{enabled:!0,position:"nearest"},title:{display:!0,text:"ATM-ITM CE-PE Lots"}}},data:{labels:t,datasets:[{label:"ITM-CE-LOTS",data:e,fill:!1,borderColor:"rgb(75, 192, 192)",backgroundColor:"rgb(75, 192, 192)",tension:.1,yAxisID:"y"},{label:"ITM-PE-LOTS",data:a,fill:!1,backgroundColor:"rgb(255, 99, 132)",borderColor:"rgb(255, 99, 132)",tension:.1,yAxisID:"y"},{label:"FUT-PRICE",data:n,fill:!1,backgroundColor:"rgb(153, 102, 255)",borderColor:"rgb(153, 102, 255)",tension:.1,yAxisID:"y1"}]},scales:{y:{type:"linear",display:!0,position:"left"},y1:{type:"linear",display:!0,position:"right"}}};let s=JSON.parse(JSON.stringify(n));s.options.plugins.title.text="All CE-PE Lots",s.data.datasets[0].data=o,s.data.datasets[1].data=l;let r=Chart.getChart("history-chart");r&&(console.log("Chart instance detected"),r.destroy());new Chart(document.getElementById("history-chart"),n);let i=Chart.getChart("history-chart-2");i&&(console.log("Chart2 instance detected"),i.destroy());new Chart(document.getElementById("history-chart-2"),s)}async function w(e,t){let a=$("#optSymbol").val(),o=[],l=new Date;var n=l.getFullYear(),s=O(l.getMonth()+1),r=O(l.getDate());let i=e==n+`-${s}-`+r?"latest":"hist";t.forEach(t=>{t=`${location.origin}/opt/OptionChainTable_tc.php?txtDate=${e}&optSymbol=${encodeURIComponent(a)}&optExpDate=${t}&dType=${i}&striketype=allstrikes&SymbType=${d}&sessionID=${p}&userName=`+u;o.push(axios.post(t,{}))});let c={ceLots:0,peLots:0,allCeLots:0,allPeLots:0,futPrice:0};try{var h=await Promise.all(o);c=function(t){let o=0,l=0,n=0,s=0,r=0;return t.forEach(t=>{let e=t.data,a=parseFloat(e.strikePriceATM).toFixed(2);parseInt(e.lot_size);r=parseFloat(e.futuresClosingPrice.replace(",","")),e.aaData.forEach(t=>{parseFloat(y(t[g.STRIKE_PRICE])).toFixed(2)<=a&&(o+=parseFloat(t[g.CALL_OI]*y(t[g.CE_LTP]))),parseFloat(y(t[g.STRIKE_PRICE])).toFixed(2)>=a&&(l+=parseFloat(t[g.PUT_OI]*y(t[g.PE_LTP]))),n+=parseFloat(t[g.CALL_OI]*y(t[g.CE_LTP])),s+=parseFloat(t[g.PUT_OI]*y(t[g.PE_LTP]))})}),{ceLots:o,peLots:l,allCeLots:n,allPeLots:s,futPrice:r}}(h)}catch(t){console.log(t)}return c}function O(t){return t=1==t.toString().length?"0"+t:t}function y(t){return"string"!=typeof(e=""+t)||isNaN(e)||isNaN(parseFloat(e))?0:t;var e}if(location.href.endsWith("OptionsMonitor.php")&&"phalvinayak"==u){$(".optionchart").remove(),$("body").append(`
        <div id="ichart-utility-buttons">
            <button class="ichart-screener-monthly mdl-button mdl-button--raised mdl-button--colored">Monthly History Scan</button>
            <button class="ichart-screener-weekly mdl-button mdl-button--raised mdl-button--colored">Weekly History Scan</button>
        </div>
        <div id="screener-title"></div>
        <div>
            <canvas id="history-chart"></canvas>
        </div>
        <div>
            <canvas id="history-chart-2"></canvas>
        </div>
    `);let e="idle";$(".ichart-screener-monthly").on("click",async t=>{t.preventDefault(),t.stopPropagation(),"idle"==e&&(console.log("start"),e="running",await a(...l()),e="idle",$(".ichart-screener-monthly").text("Monthly History Scan"),console.log("end"))}),$(".ichart-screener-weekly").on("click",async t=>{t.preventDefault(),t.stopPropagation(),"idle"==e&&(console.log("start"),e="running",await o(...l()),e="idle",$(".ichart-screener-weekly").text("Weekly History Scan"),console.log("end"))})}function l(){let t=$("#txtDate").val();var[e,a,o]=t.split("-").map(t=>parseInt(t,10));return[e,a-1,o]}})();