const WEAK_THEASHOLD=20;async function getOIData(e){e=`${location.origin}/opt/OptionChainTable.php?txtDate=${TXT_DATE}&optSymbol=${encodeURIComponent(e)}&optExpDate=25AUG22&dType=${D_TYPE}&striketype=mainstrikes&SymbType=${SYMB_TYPE}&sessionID=${SESSION_ID}&userName=`+USER_NAME;return(await axios.post(e,{})).data}function getImaginoryLinePair(a,r){return strikePair=[0,0],a.some((e,t)=>parseFloat(r)<parseFloat(e)&&(strikePair[0]={index:t-1,strike:parseFloat(a[t-1]).toFixed(2)},strikePair[1]={index:t,strike:parseFloat(a[t]).toFixed(2)},!0)),strikePair}function getOIDataObj(e){return oiChainObj={},e.aaData.forEach((e,t)=>{var a=parseFloat(e[COL_MAP.STRIKE_PRICE]).toFixed(2),r=a+"-PE";oiChainObj[a+"-CE"]={strikePrice:a,openInterest:e[COL_MAP.CALL_OI],changeinOpenInterest:e[COL_MAP.CALL_OI_CHANGE],lastPrice:e[COL_MAP.CE_LTP],delta:e[COL_MAP.CE_DELTA],index:t},oiChainObj[r]={strikePrice:a,openInterest:e[COL_MAP.PUT_OI],changeinOpenInterest:e[COL_MAP.PUT_OI_CHANGE],lastPrice:e[COL_MAP.PE_LTP],delta:e[COL_MAP.PE_DELTA],index:t}}),oiChainObj}function getSupportResistanc(t,a,r,e){let s=r[a[0].index]+"-CE",A=r[a[0].index]+"-PE",n=[],i=0,I=0,T=0,C=0,R=1;for(let e=a[0].index;e<r.length&&(t[s]&&t[A]&&(n.push({strike:t[s].strikePrice,oi:t[s].openInterest,index:t[s].index,strength:t[s].openInterest}),0==t[A].lastPrice&&i++,t[A].changeinOpenInterest<0&&I++,s=r[e+1]+"-CE",A=r[e+1]+"-PE"),10!=++R);e++);A=r[a[1].index]+"-PE",s=r[a[1].index]+"-CE";let O=[];for(let e=a[R=1].index;0<=e&&(t[A]&&(O.push({strike:t[A].strikePrice,oi:t[A].openInterest,index:t[A].index,strength:t[A].openInterest}),0==t[s].lastPrice&&T++,t[s].changeinOpenInterest<0&&C++,A=r[e-1]+"-PE",s=r[e-1]+"-CE"),10!=++R);e--);let E=a[0].strike,o=a[1].strike,N=0,S=0,L="N/A",l="N/A";2<O.length&&2<n.length&&(sortByKey(O,"oi"),E=O[0].strike,sortByKey(n,"oi"),o=n[0].strike,s=E+"-CE",A=r[t[s].index-1]+"-PE",t[s]&&t[A]&&(S=ltpCalculator("Bearish",t[s].lastPrice,t[s].delta,t[A].lastPrice,t[A].delta,e)),A=o+"-PE",s=r[t[A].index+1]+"-CE",t[s]&&t[A]&&(N=ltpCalculator("Bullish",t[s].lastPrice,t[s].delta,t[A].lastPrice,t[A].delta,e)),l=checkForWeakSR(O,"support",E),L=checkForWeakSR(n,"resistance",o));let P=5;"S-STRONG"!==l&&"S-W.T.T"!==l||P--,3<=i-T&&P--,"R-STRONG"!==L&&"R-W.T.T"!==L||P--,I>C&&P--,a=P+"-STAR";let p=5;return"R-STRONG"!==L&&"R-W.T.B"!==L||p--,3<=T-i&&p--,"S-STRONG"!==l&&"S-W.T.B"!==l||p--,C>I&&p--,e=p+"-STAR",{resistance:o,support:E,eor:N,eos:S,supportStrength:l,resistanceStrength:L,peZeroCounter:i,ceZeroCounter:T,peOIChangeCounter:I,ceOIChangeCounter:C,buyRating:a,sellRating:e}}function sortByKey(e,a){return e.sort((e,t)=>t[a]-e[a])}function checkForWeakSR(e,t,a){srItem=e.filter(e=>e.strike===a)[0];let r={};sortByKey(e,"strength");var s=srItem.strength;let A=0;return r=e[0].strike==srItem.strike?(A=e[1].strength,e[1]):(A=e[0].strength,e[0]),A>=s||Math.abs(s-A)/Math.max(s,A)*100<WEAK_THEASHOLD?"support"==t?srItem.index>r.index?"S-W.T.B":"S-W.T.T":srItem.index<r.index?"R-W.T.T":"R-W.T.B":"support"==t?"S-STRONG":"R-STRONG"}async function getSupportResistance(e){let t=await getOIData(e);var a=t.aaData.map(e=>parseFloat(e[COL_MAP.STRIKE_PRICE]).toFixed(2)),r=parseFloat(t.futuresClosingPrice.replace(",","")).toFixed(2),s=getImaginoryLinePair(a,r),A=getOIDataObj(t);return sr=getSupportResistanc(A,s,a,r),sr.perChangeSupport=parseFloat((r-sr.support)/r*100).toFixed(2),sr.perChangeResistance=parseFloat((r-sr.resistance)/r*100).toFixed(2),sr.symbol=e,sr.futPrice=r,sr.expiry=OPT_EXP_DATE,sr}async function analyseSupportResistance(){var e=["AARTIIND","ABB","ABBOTINDIA","ABCAPITAL","ABFRL","ACC","ADANIENT","ADANIPORTS","ALKEM","AMARAJABAT","AMBUJACEM","APOLLOHOSP","APOLLOTYRE","ASHOKLEY","ASIANPAINT","ASTRAL","ATUL","AUBANK","AUROPHARMA","AXISBANK","BAJAJ-AUTO","BAJAJFINSV","BAJFINANCE","BALKRISIND","BALRAMCHIN","BANDHANBNK","BANKBARODA","BATAINDIA","BEL","BERGEPAINT","BHARATFORG","BHARTIARTL","BHEL","BIOCON","BOSCHLTD","BPCL","BRITANNIA","BSOFT","CANBK","CANFINHOME","CHAMBLFERT","CHOLAFIN","CIPLA","COALINDIA","COFORGE","COLPAL","CONCOR","COROMANDEL","CROMPTON","CUB","CUMMINSIND","DABUR","DALBHARAT","DEEPAKNTR","DELTACORP","DIVISLAB","DIXON","DLF","DRREDDY","EICHERMOT","ESCORTS","EXIDEIND","FEDERALBNK","FSL","GAIL","GLENMARK","GMRINFRA","GNFC","GODREJCP","GODREJPROP","GRANULES","GRASIM","GSPL","GUJGASLTD","HAL","HAVELLS","HCLTECH","HDFC","HDFCAMC","HDFCBANK","HDFCLIFE","HEROMOTOCO","HINDALCO","HINDCOPPER","HINDPETRO","HINDUNILVR","HONAUT","IBULHSGFIN","ICICIBANK","ICICIGI","ICICIPRULI","IDEA","IDFC","IDFCFIRSTB","IEX","IGL","INDHOTEL","INDIACEM","INDIAMART","INDIGO","INDUSINDBK","INDUSTOWER","INFY","INTELLECT","IOC","IPCALAB","IRCTC","ITC","JINDALSTEL","JKCEMENT","JSWSTEEL","JUBLFOOD","KOTAKBANK","L&TFH","LALPATHLAB","LAURUSLABS","LICHSGFIN","LT","LTI","LTTS","LUPIN","M&M","M&MFIN","MANAPPURAM","MARICO","MARUTI","MCDOWELL-N","MCX","METROPOLIS","MFSL","MGL","MINDTREE","MOTHERSON","MOTHERSUMI","MPHASIS","MRF","MUTHOOTFIN","NAM-INDIA","NATIONALUM","NAUKRI","NAVINFLUOR","NBCC","NESTLEIND","NMDC","NTPC","OBEROIRLTY","OFSS","ONGC","PAGEIND","PEL","PERSISTENT","PETRONET","PFC","PIDILITIND","PIIND","PNB","POLYCAB","POWERGRID","PVR","RAIN","RAMCOCEM","RBLBANK","RECLTD","RELIANCE","SAIL","SBICARD","SBILIFE","SBIN","SHREECEM","SIEMENS","SRF","SRTRANSFIN","SUNPHARMA","SUNTV","SYNGENE","TATACHEM","TATACOMM","TATACONSUM","TATAMOTORS","TATAPOWER","TATASTEEL","TCS","TECHM","TITAN","TORNTPHARM","TORNTPOWER","TRENT","TVSMOTOR","UBL","ULTRACEMCO","UPL","VEDL","VOLTAS","WHIRLPOOL","WIPRO","ZEEL"];let t=[],a=0;for(scrip of e)t.push(await getSupportResistance(scrip)),$(".ichart-sr-scan").text(`Screening ${++a} of `+e.length);renderSRTable(t)}function renderSRTable(e){e&&($("#option-SR-scan_wrapper").length&&$("#option-SR-scan").DataTable().clear().destroy(),$("body").append('<table id="option-SR-scan" class="display" width="100%"></table>'),console.log(e),$("#option-SR-scan").DataTable({data:e,filter:!0,searching:!0,iDisplayLength:25,columns:[{data:"symbol",title:"EQ Symbol",searchable:!0},{data:"futPrice",title:"Future Price",searchable:!1},{data:"expiry",title:"Expiry Date",searchable:!1},{data:"buyRating",title:"Buy Rating",searchable:!1},{data:"sellRating",title:"Sell Rating",searchable:!1},{data:"support",title:"Support",searchable:!1},{data:"eos",title:"EOS",searchable:!1},{data:"supportStrength",title:"Support Strength",searchable:!1},{data:"resistance",title:"Resistance",searchable:!1},{data:"eor",title:"EOR",searchable:!1},{data:"resistanceStrength",title:"Resistance Strength",searchable:!1},{data:"perChangeSupport",title:"% Chg Support",searchable:!1},{data:"perChangeResistance",title:"% Chg Resistance",searchable:!1},{data:"ceZeroCounter",title:"CeZeros",searchable:!1},{data:"peZeroCounter",title:"PeZeros",searchable:!1},{data:"ceOIChangeCounter",title:"Ce OI Change Cnt",searchable:!1},{data:"peOIChangeCounter",title:"Pe OI Change Cnt",searchable:!1}]}))}